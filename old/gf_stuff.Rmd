---
title: ""
output:
  html_document:
    highlight: "tango"
editor_options: 
  chunk_output_type: inline
---

```{r, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r state-14days-avg-script, message = FALSE, results = "hide", warning = FALSE}
source("script/plot/state_14days_avg.R") #creates hex map of state avg gf for past n days
```


This plot is a quick overview of the last two weeks for each state.  Using the three colors you can see which states have seen an average decrease in daily cases for 14 days (i.e. growth factor consistently below 1) and may be ready to start the re-opening process, which states are not ready to reopen and finally, which states may need additional social-distancing and lock-down measures.  

As mentioned in the Growth Factor tab, some states will have very large average growth factors.  This is most likely due to having 0 cases on one day and then a large number of cases the next day; often caused by test availability or reporting.  

```{r state-14days-avg-img, out.width = "100%", fig.align = 'center'}
knitr::include_graphics("img/state_14days_avg.png")
```


```{r state-weekly-script, message = FALSE, results = "hide", warning = FALSE}
source("script/plot/state_weekly_gif.R") #creates hex map of state avg gf for past n days

first_date <- min(covid19_state_weekly$date)
```


This plot shows how the weekly average growth factor has changed by state since the start of the pandemic.  Week 1 starts on January 22, 2020, which is the first day data is available.  Although 7 days is an arbitrary cut-off point, separating the data into sections and averaging the growth factor helps see the spread of the virus. 

```{r state-weekly-img, out.width = "100%", fig.align = 'center'}
knitr::include_graphics("img/state_weekly_gif.gif")
```

**Why are some of the growth factors negative?**
Having a negative growth factor is theoretically impossible; however some states end up having negative growth factors because they update their total case numbers to a lower number.  This results in having negative daily cases and then a negative growth factor.  


### Growth Factor Average or Growth Factor on Average of New Cases? 

What if instead of looking at the average of the growth factor, we calculated the growth factor on the average of new cases?  I'm going to call this $\text{GF}_{14}$ to represent that it's the growth factor based on the 14-day moving average of new cases.  

Looking at the new cases 14-day moving average, it is clearly smoother than the raw new cases and most of the cyclical nature has been removed.  

```{r, fig.height = 2.5}
plot_ma_nc <- ggplot(covid19_US_adj, aes(x=date, y=MA_new_cases))+
  geom_line(alpha=0.6, color = blue_comp) +
  geom_area(alpha = 0.3, fill = blue_comp) +
  date_scaling +
  thousands_scaling +
  ggtitle("New Cases 14-Day Moving Average") +
  theme_minimal()+
  theme(
      plot.title = element_text(hjust = 0.5, size = subtitle_size)
    , axis.title.x=element_blank()
    , axis.title.y=element_blank()
    , plot.margin  = margin(t=15, r=15, b=15, l=0)
    , axis.ticks.length = unit(5, "pt")
  ) 
plot_ma_nc
```


Using the new cases 14-day moving average, I am calculating $\text{GF}_{14}$ as follows: 

$$
\text{GF}_{14} = \frac{
 \frac{1}{14}\sum_{N-14}^N \text{New-Cases}_i
}{
 \frac{1}{14}\sum_{N-15}^{N - 1} \text{New-Cases}_i
}
$$

I am showing both the growth factor 14-day moving average and the $\text{GF}_{14}$ for comparison.  

<br> 

```{r}
plot_gf_14 <- ggplot(covid19_US_adj, aes(x=date, y=gf_14))+
  red_box +
  geom_line(alpha=0.6, color = blue_comp) +
  geom_area(alpha = 0.3, fill = blue_comp) +
  gf_info_cap +
  date_scaling +
  scale_y_continuous(limit = c(0, 2), expand = c(0, 0)) +
  ggtitle(TeX("$GF_{14}$")) +
  theme_minimal()+
  theme(
      plot.title = element_text(hjust = 0.5, size = subtitle_size)
    , axis.title.x=element_blank()
    , axis.title.y=element_blank()
    , plot.margin  = margin(t=0, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  ) 

plot_ma_gf <- ggplot(covid19_US_adj, aes(x=date, y=MA_growth_factor))+
  red_box+
  geom_line(alpha=0.6, color = blue_comp) +
  geom_area(alpha = 0.3, fill = blue_comp) +
  gf_info_cap +
  date_scaling +
  scale_y_continuous(limit = c(0, 2), expand = c(0, 0)) +
  ggtitle(TeX("Growth Factor 14-Day Moving Average")) +
  theme_minimal()+
  theme(
      plot.title = element_text(hjust = 0.5, size = subtitle_size)
    , axis.title.x=element_blank()
    , axis.title.y=element_blank()
    , plot.margin  = margin(t=0, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  )


plot_grid(plot_ma_gf, plot_gf_14, ncol = 2, align = "h")
```

<br>  

It turns out in this case it does not make make a significant difference!  Even when looking at the growth factor based on the 14-day moving average of new cases (smoothing over the cyclical nature of new cases reporting) the result is a growth factor, $\text{GF}_{14}$ that is not significantly deviating from 1.  

 

```{r}
df1 <- covid19_US %>% 
  select(growth_factor, MA_growth_factor, gf_14)

df2 <- covid19_US_adj %>% 
  select(growth_factor, MA_growth_factor, gf_14)

df3 <- covid19_US %>% 
  filter(date > current_date - 14) %>%
  select(growth_factor, MA_growth_factor, gf_14)

sd1 <- mapply(sd, na.rm = TRUE, df1)
sd2 <- mapply(sd, na.rm = TRUE, df2)
sd3 <- mapply(sd, na.rm = TRUE, df3)

sd_df <- rbind(sd1, sd2, sd3)
rownames(sd_df) <- c("All dates", "Since 2020-03-15", "Last 14 days")
colnames(sd_df) <- c("Growth Factor", "Growth Factor 14-day MA", "GF_14")

kable(sd_df,  caption = "Standard Deviations") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"), full_width = F, position = "float_left", font_size = 12)

```


Looking at the standard deviations, it is unsurprising that the $\text{GF}_{14}$ has the least amount of deviation, followed by the growth factor 14-day moving average, and the raw growth factor has the most deviation.  

Since there is a not a large difference between growth factor 14-day moving average and $\text{GF}_{14}$, I'm going to use the growth factor 14-day moving average instead of $\text{GF}_{14}$.  When available, I want to keep the calculations as simple and close to the raw data as possible.  