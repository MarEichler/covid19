---
title: ""
output:
  html_document:
    highlight: "tango"
editor_options: 
  chunk_output_type: console
---



I am restricted the charts to show values on March 15, 2020 and after.  This is when preventative measures started to increase dramatically.  

### Is the pandemic slowing? 

One important calculation is the growth factor, as outlined in <a href = "https://www.youtube.com/watch?v=Kas0tIxDvrg" target = "_blank"> 3Blue1Brown's youtube video on exponential growth </a>.  The growth rate is calculated as follows: 

$$
\text{Growth Factor} = \frac{ \text{New-Cases}_N}{\text{New-Cases}_{N-1}}
$$
where $N$ is a given day.  Essentialy this is taking the amount new cases today and dividing them by the amount of new cases yesterday.  

The growth factor can be very helpful in determining if the pandemic is slowing.  If the growth factor is less than 1, this means that the amount of new cases today is less than yesterday.  Once there are multiple days with a growth factor less than 1 - this is a strong sign that the pandemic is slowing down.  

**Adjustment to Growth Factor**  
What if there were 0 cases yesterday?  This would make the growth factor undefined (or $\infty$ according to R).  This makes it difficult to look at trends.  I have adjusted the growth factor so that if the pervious day had 0 cases; the current day's growth factor is equal to the number of new cases: 

$$
\text{Growth Factor} = \begin{cases}
\frac{ \text{New-Cases}_N}{\text{New-Cases}_{N-1}} & \text{if } \text{New-Cases}_{N-1} \neq 0 
\\[1ex]
\text{New-Cases}_N & \text{if } \text{New-Cases}_{N-1} = 0 
\end{cases}
$$
When I made this adjustment I was thinking about the early stages of the pandemic when the number of cases per day are 0, 1, or 2.  However, given the test scarcity and reporting times there are situations in counties or states where there were 0 cases one day and then hundred or thousands the next day.  This is why some of growth factors are much larger.  


```{r gf-plot-setup, fig.width=4, fig.height=4}
#captions 
gf_max <- max(covid19_US_adj$growth_factor)


cap_gf <- paste(
  strwrap("A growth factor below 1 means new cases are decreasing,\ni.e. the pandemic is slowing"
          , 30)
  , collapse = "\n"
)

#plot set up 
plot_gf  <- ggplot(covid19_US_adj, aes(x=date, y=growth_factor))+
  annotate("rect", xmin = x_min, xmax = x_max, ymin = 1, ymax =  Inf, fill = gf2plus, alpha = 0.2) +
#  geom_line(alpha=0.6) +
  geom_area(alpha = 0.3) +
  annotate("text", x = x_min + 1, y = 0, label = cap_gf, vjust=-0.25, hjust= 0, size = 3, color = "grey95") +
  date_scaling +
  scale_y_continuous(limit = c(0, 2.1), expand = c(0, 0)) +
  theme_minimal()+
  theme(
      plot.title = element_text(hjust = 0.5, size = subtitle_size)
    , axis.title.x=element_blank()
    , axis.title.y=element_blank()
    , plot.margin  = margin(t=0, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  ) 
```


Similar to the new cases per day; there can be a lot of variability in growth rates.  In order to get a better sense of the trend I am showing two smoothing curves: LOESS smoothing (with span = 0.9) and a 14 day moving average.   

The growth rate shows a different trend than new cases.  Here, the growth rate has stayed around 1 since mid-April.  Compare that to the new cases plot on the Overview tab, which shows a downward trends.  The the growth factor not decreasing people 1 due may be due to the cyclical nature of new cases reporting (high during the week, low during the weekends) - but it could also be showing that although the decrease in new cases is positive we are not out of the woods yet.  

```{r}
title_l <- "LOESS Smoothing "

loess_smooth <- stat_smooth(
      geom="line"
    , size = 1.25
    , color = blue_comp
    , se = FALSE 
    , alpha = 0.6
    , method = "loess"
    , formula = y~x
    , span = 0.9
  )

plot_gf_l  <- plot_gf +
  loess_smooth +
  ggtitle(title_l)

title_ma <- paste("Moving Average, k =", ma_k)


plot_gf_ma  <- plot_gf + 
  geom_line(
      aes(y = MA_growth_factor)
    , size = 1.25
    , color = blue_comp
    , alpha = 0.6
  ) + 
  ggtitle(title_ma)



grid.arrange(
    plot_gf_l
  , plot_gf_ma
  , nrow = 1
  ,top=textGrob(
      paste("Growth Factor per Day", sep = "\n")
    , gp=gpar(fontsize=title_size, fontface = "bold")
  )
)
```

<br>  
### Recent Values by Day for US

```{r values-table-gf}
#transpose table; easier to read
covid19_US_adj %>%
  arrange(desc(date)) %>%
  top_n(14, wt=date) %>%
  #format data for output tabe
  mutate(
      Date = format(date, '%a, %b %d, %Y')
    , `Total Cases` = formatC(total_cases, big.mark=",", format="d")
    , `New Cases`  = formatC(new_cases, big.mark=",", format="d")
    , `Growth Factor` = round(growth_factor, 2)
  ) %>%
  #color Growth Factor based on value 
  mutate(
    `Growth Factor` = cell_spec(
      `Growth Factor`, color = 
          ifelse( growth_factor > 1, gf2plus, colorspace::lighten(gf2plus, 0.4))
      , bold = T
      )
  ) %>%
  #re-order to group cases and death information together 
  select(
      Date
    , `Total Cases`
    , `New Cases`
    , `Growth Factor`
    ) %>%
  kable(
    align=c('l', rep('r', 5))
    , escape = F
  ) %>%
  kable_styling(
    bootstrap_options = c(
      #adds stiped color to rows
        "striped"
      #highlight row when hover over it 
      , "hover"
      #table doesn't have to be full width 
      , full_width = FALSE
      #make it horizontally scrollable
      , "responsive"
      )
    ) %>%
  row_spec(1, bold=T, color="white", background = "rgba(0, 0, 0, .5)")
```

<br>  
  
### Recent Growth Factor for each state 

Since most of the COVID-19 measures are enacted by the state; it may be more helpful for the individual to see the growth factor for the last 14 days in a specific state.  

```{r geofacet, message = FALSE, results = "hide", warning = FALSE}
source("script/plot/geofacet.R") #creates facet_map of states' raw gf for past 14 days 
```


```{r, out.width = "100%", fig.align = 'center'}
knitr::include_graphics("img/facet_map.png")
```
<br>

### Still want to look at more plots? 

Build your own growth factor plot for a given state and time period by using a shiny app:  
<a href="https://mareichler.shinyapps.io/state_gf/" target = "_blank">https://mareichler.shinyapps.io/state_gf/</a> 

