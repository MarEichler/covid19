---
title: ""
output:
  html_document:
    highlight: "tango"
    code_folding: "hide"
editor_options: 
  chunk_output_type: inline
---


```{r packages-global-options, results="hide", warning=FALSE, message=FALSE}
library(tidyverse)
library(gridExtra)
library(grid)
library(knitr)
library(lubridate)
library(scales)
library(ggrepel)
library(kableExtra)
library(zoo)
knitr::opts_chunk$set(fig.width=8, fig.height = 4, dpi=300)
```

```{r import-colors}
#read in colors 
source("script/colors.R")
```


This data is downloaded from 
<a href="https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/" target="_blank" >
USA Facts CDC</a>. This data requires formating the dates and calculating the new cases and deaths by day.  USA Facts gets data by county on a daily basis, this is totaled to get values for each day for the entire US. 

The
<a href="https://www.cdc.gov/coronavirus/2019-ncov/cases-updates/cases-in-us.html" target="_blank">
American CDC </a> 
links to USA Facts under Cases & Death by County.  Although for the below maps data per state/county is not used, information on that level is used on the next tab when ploting maps.    


```{r download-process-data}
source("script/usafacts_data.R")
```


```{r load-wrangle-data}
load("data/covid19_US.rda")
#number of rows; use in `for loop`  
R <- nrow(covid19_US)

#GROWTH FACTOR  
covid19_US$growth_factor <- NA

#calculate growth rate
#start with 2 because when r=1; 1-1= 0 (don't have a 0th row)
for (r in 2:R){
  covid19_US$growth_factor[r] <- 
    #Growth Factor = New Cases Today / New Cases Yesterday 
    covid19_US$new_cases[r] /  covid19_US$new_cases[r-1] 
}

covid19_US <- covid19_US %>%
  mutate(
    growth_factor = ifelse(growth_factor == Inf, new_cases, growth_factor)
         )

#DEATH PERCENTAGE  
covid19_US <- mutate(covid19_US, death_percentage = total_deaths / total_cases)

#calculate moving average 
ma_k <- 14
covid19_US$MA_growth_factor <- c(rep(NA, ma_k - 1), rollmean(covid19_US$growth_factor, k=ma_k))
covid19_US$MA_new_cases <- c(rep(NA, ma_k - 1), rollmean(covid19_US$new_cases, k=ma_k))


#save copy of data 
write.csv(covid19_US, "data/data_usafacts.csv")
```


I am restricted the charts to show values on March 15, 2020 and after.  This is when preventative measures started to increase dramatically.  In addition, given the small number of cases prior to this date caused great variability in the growth rate and has multiple instances where it's  NA or equal to infinity.  

```{r start-date}
startdate <- "2020-03-15"
#3/18 - start 'lockdown' ; after large growth factorsâ†•

covid19_US_adj <- covid19_US  %>%
  #only look at data after a given start date
  filter(date >= as.Date(startdate))
```


```{r current-values}
#find current values to use as labels 

current_date <- max(covid19_US_adj$date)

current_values <- covid19_US_adj %>%
    #return row that has current date
    filter(date == current_date)


current_US_deaths      <- current_values$total_deaths
current_US_totalcases  <- current_values$total_cases
current_US_newcases <- current_values$new_cases
current_US_growthfact  <- current_values$growth_factor
current_US_deathperc   <- current_values$death_percentage
current_US_newdeaths <- current_values$new_deaths
```

 

```{r gen-scaling}
#set the limits for the x-axis
#want the limits to be the same so the axes for different charts line up
#need to add extra for the bar charts 

x_min <- as.Date(startdate)-.5
x_max <- as.Date(current_date)+1

#ggplot set ups 
date_scaling <- scale_x_date(
      name = NULL
    , labels = date_format("%b-%d")
    , limits = c(x_min, x_max)
    , expand = c(0, 0)
  )

thousands_scaling <- scale_y_continuous(
      name = NULL
    , limits = c(0, NA)
    , labels = scales::unit_format(unit = "k", scale = 1e-3, accuracy = 1, big.mark = ",")
    , expand = c(0, 0)
  )

title_size <- 14
subtitle_size <- 12
```

###  Total Cases and Total Deaths  
These show the cumulative total of cases and deaths.  These total values are important; however they are not helpful for figuring out whether the pandemic is slowing down or growing.  

```{r tc-td-plot, fig.height=3}
covid_tidy <- covid19_US_adj %>%
  select(date, total_cases, total_deaths) %>%
  pivot_longer(
      cols = c(total_cases, total_deaths)
    , names_to = "type"
    , values_to = "count"
  ) 

total_labels <- covid_tidy %>%
  filter(date == current_date) %>%
  mutate(
    label = paste("Current Total", formatC(count, big.mark=",", format="d"), sep = "\n")
  )

ggplot(covid_tidy, aes(date, count)) + 
  geom_area(alpha = 0.4)+
  geom_line(
      size = 1
    , alpha = 0.6
  )+
  facet_wrap(
    .~factor(type, labels = c("Total Cases by Day", "Total Dealths by Day"))
    , ncol=2
    , scales = "free_y"
  ) + 
  date_scaling +
  thousands_scaling +
  geom_text(
      data = total_labels 
    #format label so there is a comma after three places 
    , aes(
          label = label
        , y = -Inf
        , x = current_date
      )
    , vjust = -0.15
    , hjust=1.05 
    , size = 6
    , fontface = "bold"
    , color = "white"
    ) +
  theme_minimal() +
#  ggtitle("COVID-19 in the United States by Day") +
  theme(
      plot.title = element_text(size = title_size, hjust = 0.5)
  #  , axis.text.x = element_text(hjust = 0.2)
    , strip.text.x = element_text(size = subtitle_size)
    , panel.spacing = unit(.5, "in")
    , plot.margin  = margin(t=0, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  )

```


### Growth Factor and New Cases 
One important calculation is the growth factor, as outline in <a href = "https://www.youtube.com/watch?v=Kas0tIxDvrg" target = "_blank"> 3Blue1Brown's youtube video on exponential growth </a>.  The growth rate is calculated as follows: 

$$
\text{Growth Factor} = \frac{ \text{New-Cases}_N}{\text{New-Cases}_{N-1}}
$$
where $N$ is a given day.  

In order to see if the pandemic is slowing down, it is helpful to look at the growth factor and the daily new cases.  For both these values; we want to see a decrease in values from day to day - which indicates that less people are getting sick.  Recall that a growth factor less than 1 is a positive sign that the growth of cases is slowing down.  Growth factor is directly related to new cases - if daily new cases goes now the growth factor is less than 1; if daily cases goes up the growth factor is greater than one.  These two charts represent the same information in two differnt ways.  

```{r gf-plot-setup, fig.width=4, fig.height=4}
#captions 
gf_max <- max(covid19_US_adj$growth_factor)


cap_gf <- paste(
  strwrap("A growth factor below 1 means new cases are decreasing,\ni.e. the pandemic is slowing"
          , 30)
  , collapse = "\n"
)

#plot set up 
plot_gf  <- ggplot(covid19_US_adj, aes(x=date, y=growth_factor))+
  #annotate("rect", xmin = x_min, xmax = x_max, ymin =  0, ymax =  1, fill = gf0_1, alpha = 0.3) +
  #annotate("rect", xmin = x_min, xmax = x_max, ymin =  1, ymax =  2, fill = gf1_2, alpha = 0.3) +
  annotate("rect", xmin = x_min, xmax = x_max, ymin = 1, ymax =  Inf, fill = gf2plus, alpha = 0.45) +
  geom_line(alpha=0.3) +
  geom_area(alpha = 0.6) +
  annotate("text", x = x_min + 1, y = 0, label = cap_gf, vjust=-0.25, hjust= 0, size = 3, color = "grey95") +
  date_scaling +
  scale_y_continuous(limit = c(0, 2.1), expand = c(0, 0)) +
  ggtitle("Growth Factor per Day") + 
  theme_minimal()+
  theme(
      plot.title = element_text(hjust = 0.5, size = subtitle_size)
    , axis.title.x=element_blank()
    , axis.title.y=element_blank()
    , plot.margin  = margin(t=0, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  ) 
```

```{r dc-plot-setup}  
#daily cases set up 

plot_dc <- ggplot(covid19_US_adj, aes(x=date, y=new_cases))+
  geom_col(alpha=0.3) +
  date_scaling + 
  thousands_scaling +
  ggtitle("New Cases per Day") + 
  theme_minimal()+
  theme(
      plot.title = element_text(hjust = 0.5, size = subtitle_size)
    , axis.title.x=element_blank()
    , axis.title.y=element_blank()
    , plot.margin  = margin(t=0, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  )
```


There can be a lot of variability in the daily points - this is due to many different variables.  On variable is the availability of tests, cases will go down if there is scarcity of tests and rise dramatically when more tests become available.  One way to help get a better sense over the overall trend is by smoothing the data.  


```{r loess-plots, warning = FALSE}  
#LOESS CURVE

title_l <- "LOESS Smoothing "

loess_smooth <- stat_smooth(
      geom="line"
    , size = 1.25
    , color = blue_comp
    , se = FALSE 
    , alpha = 0.6
    , method = "loess"
    , formula = y~x
    , span = 0.9
  )

plot_gf_l  <- plot_gf +
  loess_smooth 

plot_dc_l <- plot_dc +
  loess_smooth

grid.arrange(
    plot_gf_l
  , plot_dc_l
  , nrow = 1
  ,top=textGrob(
      paste(title_l, sep = "\n")
    , gp=gpar(fontsize=title_size, fontface = "bold")
  )
)
```




```{r ma-plot, warning = FALSE}  
#MOVING AVERAGE 

title_ma <- paste("Moving Average, k =", ma_k)


plot_gf_ma  <- plot_gf + 
  geom_line(
      aes(y = MA_growth_factor)
    , size = 1.25
    , color = blue_comp
    , alpha = 0.6
  )
  

plot_dc_ma <- plot_dc +
  geom_line(
    aes(y = MA_new_cases)
    , size = 1.25
    , color = blue_comp
    , alpha = 0.6
  )

grid.arrange(
    plot_gf_ma
  , plot_dc_ma
  , nrow = 1
  ,top=textGrob(
      paste(title_ma, sep = "\n")
    , gp=gpar(fontsize=title_size, fontface = "bold")
  )
)
```


### New Deaths and Death Percentage   

I also wanted to look at the dealth percentage which I calculated as the total number of deaths divided by the total number of cases for a given day.  


```{r dp-plot}
plot_dp <- ggplot(covid19_US_adj, aes(date, death_percentage)) + 
  geom_line(color = "grey40", size = 1) + 
  date_scaling + 
  scale_y_continuous(
      name = "Total Dealths / Total Cases"
    , limits = c(0, NA)
    , labels = scales::percent
  ) +
  ggtitle("Dealth Percentage per Day") + 
  theme_minimal()+
  theme(
      plot.title = element_text(hjust = 0.5, size = subtitle_size)
    , axis.title.x=element_blank()
    , plot.margin  = margin(t=0, r=15, b=15, l=0)
    , axis.ticks.length = unit(5, "pt")
  )
```

```{r nd-plot}
plot_nd <- ggplot(covid19_US_adj, aes(date, new_deaths)) + 
  geom_col(alpha=0.3) +
  date_scaling + 
  thousands_scaling +
  ggtitle("New Deaths per Day") + 
  theme_minimal()+
  theme(
      plot.title = element_text(hjust = 0.5, size = subtitle_size)
    , axis.title.x=element_blank()
    , axis.title.y=element_blank()
    , plot.margin  = margin(t=15, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  )

```


```{r dp-nd-plot}
cowplot::plot_grid(
    plot_dp
  , plot_nd
  , nrow = 1
  , align = "h"
)
```





### Values for Past 14 Days 

```{r values-table}
#transpose table; easier to read
covid19_US_adj %>%
  arrange(desc(date)) %>%
  top_n(14, wt=date) %>%
  #format data for output tabe
  mutate(
      Date = format(date, '%a, %b %d, %Y')
    , `Total Cases` = formatC(total_cases, big.mark=",", format="d")
    , `New Cases`  = formatC(new_cases, big.mark=",", format="d")
    , `Growth Factor` = round(growth_factor, 2)
    , `Total Deaths` = formatC(total_deaths, big.mark=",", format="d")
    , `New Deaths` = formatC(new_deaths, big.mark=",", format="d")
    , `Death Percentage` = percent(death_percentage, accuracy=0.001)
  ) %>%
  #color Growth Factor based on value 
  mutate(
    `Growth Factor` = cell_spec(
      `Growth Factor`, color = 
          ifelse(
            growth_factor > 2, gf2plus, 
              ifelse(growth_factor > 1,  gf1_2, gf0_1
                     )
            )
      , bold = T
      )
  ) %>%
  #re-order to group cases and death information together 
  select(
      Date
    , `Total Cases`
    , `New Cases`
    , `Growth Factor`
    , `Total Deaths`
    , `New Deaths`
    , `Death Percentage`
    ) %>%
  kable(
    align=c('l', rep('r', 5))
    , escape = F
  ) %>%
  kable_styling(
    bootstrap_options = c(
      #adds stiped color to rows
        "striped"
      #highlight row when hover over it 
      , "hover"
      #table doesn't have to be full width 
      , full_width = FALSE
      #make it horizontally scrollable
      , "responsive"
      )
    ) %>%
  row_spec(1, bold=T, color="white", background = "rgba(0, 0, 0, .5)")

```
