---
title: "Tracking COVID-19"
output:
  html_document:
#    toc: true
#    toc_float: true
    toc_depth: 4
    highlight: "tango"
---

```{r, echo=FALSE, eval=FALSE}
#r chunks are not named
#this is so the Rmd can be called twice in the index.Rmd file
#     once for just the charts
#     once for the charts and the data (don't have to worky about putting into new file )

```


```{r, results="hide", warning=FALSE, message=FALSE}
library(tidyverse)
library(gridExtra)
library(grid)
library(knitr)
library(lubridate)
library(scales)
library(ggrepel)
library(kableExtra)
AccentCol01 <- "firebrick"
knitr::opts_chunk$set(fig.width=10, fig.height=4, dpi=300)
```

The data is taken from [Our World in Data](https://ourworldindata.org/coronavirus).  There are csv files available for download for deaths, total cases, and new cases, each by date.  

```{r, message=FALSE}
# https://ourworldindata.org/coronavirus
owid_deaths <- read_csv("total-deaths-covid-19.csv")
owid_totalcases <- read_csv("total-cases-covid-19.csv")
owid_newcases <- read_csv("daily-cases-covid-19.csv ")

#column names that the data sets should be joined as 
match_cols <- c("Entity", "Code", "Date")

#do nested inner_joins to join all three data sets on the above critera 
covid19 <- inner_join(
    owid_deaths
  , inner_join(
        owid_totalcases
      , owid_newcases
      , by =match_cols
      )
  , by=match_cols
  )
```

```{r}
#I'm just look at the data for the United States.   

covid19_colnames <- colnames(covid19)
covid19_US <- covid19 %>%
    mutate(Date = 
           #change column type to date 
           as.Date(
             #parse through current string format mmm d, yyyy
             #requires lubricate package 
             parse_date_time(Date, orders=c("mdy"))
             )
         ) %>% 
  #only look at USA
  filter(Entity == "United States") %>% 
  #only return date and daily count 
  #rename long column names into shorter names 
  select(
      Date
    , "Total Deaths" = covid19_colnames[4]
    , "Total Cases"  = covid19_colnames[5]
    , "Daily Cases"  = covid19_colnames[6]
    )
```

One important calculation is the growth rate.  The growth rate is calculated as follows: 

$$
\text{Growth Rate} = \frac{ \text{New-Cases}_N}{\text{New-Cases}_{N-1}}
$$
where $N$ is a given day.  

If the growth rate is below 1 that means the number of new cases is slowing down - this is a positive sign.  

I also wanted to look at the dealth percentage which I calculated as the total number of dealths divided by the total number of cases for a given day.  

```{r}
R <- nrow(covid19_US)

covid19_US$`Growth Factor` <- NA

#calculate growth rate
#start with 2 because when r=1; 1-1= 0 (don't have a 0th row)
for (r in 2:R){
  covid19_US$`Growth Factor`[r] <- 
    #Growth Factor = New Cases Today / New Cases Yesterday 
    covid19_US$`Daily Cases`[r] /  covid19_US$`Daily Cases`[r-1] 
}


covid19_US$`Death Percentage` <- NA

# calculate dealth percentage  
for (r in 1:R){
  covid19_US$`Death Percentage`[r] <- 
    #dealth percentage = total deaths / total cases 
    covid19_US$`Total Deaths`[r] /  covid19_US$`Total Cases`[r] 
}
```

I am restricted the charts to show values after March 17, 2020 (first date in data set is March 18, 2020).  This is when preventative measures started to increase dramatically.  In addition, given the small number of cases prior to this date caused great variability in the growth rate and has multiple instances where it's  NA or equal to infinity.  

```{r}
startdate <- "2020-03-17"
#3/18 - start 'lockdown' ; after large growth factorsâ†•


covid19_US_adj <- covid19_US  %>%
  #only look at data after a given start date
  filter(Date > as.Date(startdate)) %>%
  #remove any NA's that are still present 
  drop_na()
```


```{r}
#find current values to use as labels 

current_date <- max(covid19_US_adj$Date)

current_values <- covid19_US_adj %>%
    #return row that has current date
    filter(Date == current_date)


current_US_deaths     <- current_values$`Total Deaths`
current_US_totalcases <- current_values$`Total Cases`
current_US_newcases   <- current_values$`Daily Cases`
current_US_growthfact <- current_values$`Growth Factor`
current_US_deathperc  <- current_values$`Death Percentage`
```

###  Total Cases  
```{r}
plot_tc <- ggplot(covid19_US_adj, aes(x=Date, y=`Total Cases`))+
  #use geom_col because counts per day have alread been counted 
  geom_col(alpha=0.6)+
  ggtitle("Total Cases of COVID-19 in the United States by Day")+
  geom_label(
      data=current_values
    #format label so there is a comma after three places 
    , aes(label = formatC(`Total Cases`, big.mark=",", format="d"))
    )+
  theme_minimal()+
  theme(
     legend.position = "none"
    ,axis.title.x=element_blank()
    ,axis.title.y=element_blank()
  )+
  scale_x_date(breaks=date_breaks("7 days")
              , labels = date_format("%b-%d")
              , minor_breaks=date_breaks("1 day")
              , lim = c(as.Date(startdate)+.5, as.Date(current_date)+1)  
              )+
  #add commas to numbers in y axis; requires scales package
  scale_y_continuous(labels=comma)
plot_tc
```

### Growth Factor and Daily Cases 
Recall that a growth factor less than 1 is a positive sign that the growth of cases is slowing down.  Growth factor is directly related to daily cases - if daily cases goes now the growth factor is less than 1; if daily cases goes up the growth factor is greater than one.  These two charts represent the same information in two differnt ways.  

```{r}
#Start by plotting the growth factor.   

plot_gf  <- ggplot(covid19_US_adj, aes(x=Date, y=`Growth Factor`))+
  geom_point(size=2, alpha=0.6)+
  geom_line(size=1, alpha=0.6)+
  geom_hline(yintercept = 1, linetype="dotted", color=AccentCol01, size=1)+
  ggtitle("Growth Factor of COVID-19 in the United States by Day")+
  # ADD LABEL 
  geom_label(
      data = current_values
    , aes(label = round(`Growth Factor`, 4))
    )+
  theme_minimal()+
  theme(
     legend.position = "none"
    ,axis.title.x=element_blank()
    ,axis.title.y=element_blank()
  )+
  scale_x_date(breaks=date_breaks("7 days")
              , labels = date_format("%b-%d")
              , minor_breaks=date_breaks("1 day")
              , limits = c(as.Date(startdate)+.5, as.Date(current_date)+1) 
              )+
  #want growth rate to go to 0
  ylim(0, NA)
```

```{r}  
#Then plot the daily cases.   

plot_dc <- ggplot(covid19_US_adj, aes(x=Date, y=`Daily Cases`))+
  #use geom_col because counts per day have alread been counted 
  geom_col(alpha=0.6)+
  ggtitle("New Cases of COVID-19 in the United States by Day")+
  # ADD LABEL 
  geom_label(
      data = current_values
    #format label so there is a comma after three places 
    , aes(        label = formatC(`Daily Cases`, big.mark=",", format="d"))
    )+
  theme_minimal()+
  theme(
    #remove all legents 
     legend.position = "none"
     # remove x and y axes 
    , axis.title.x = element_blank()
    , axis.title.y = element_blank()
  )+
  scale_x_date(breaks=date_breaks("7 days")
              , labels = date_format("%b-%d")
              , minor_breaks=date_breaks("1 day")
              , lim = c(as.Date(startdate)+.5, as.Date(current_date)+1)  
              )+
  #add commas to numbers in y axis; requires scales package
  scale_y_continuous(labels=comma)
```

```{r, fig.height=8}  
#Put the plots together and have the plot axes line up

gGF <- ggplotGrob(plot_gf)
gDC <- ggplotGrob(plot_dc)
grid.newpage()
grid.draw(rbind(gGF, gDC))
```

### Total Deaths and Death Percentage   

In order to have separate axes on the same plot - I have to start by finding the multiplier that will transform the primary axis into the secondary axis.  I start by defining two function: one for finding rounding to a specific base (i.e. rounding to the nearest 5,000) and a function for finding the upper limit for the primary y-axis.  
```{r}
func_mround <- function(x, base){
  base*round(x/base)
}

Ylim <- function(curr_val, base){
round_curr_val <- func_mround(curr_val, base)
if( round_curr_val - curr_val < 0 ){
  lim <- round_curr_val + base
} else {
  lim <- round_curr_val
}
return(lim)
}
```

I am setting the primary (total dealths) y-axis base to 5,000.  That is use to find the upper limit for the primary y-axis.  After limit is found; that can be used to calculate the transform multiplier.  This takes some extra coding because I want the secondary axis to match up with the primary axis.  

As an example, say the primary axis is from 0 to 20 and it has 4 breaks (so 5, 10, 15, 20).  Say the secondary axis is a percentage.  I want to make sure that the the upper limit of the secondary axis is divisible by 4 so that the 'breaks' line up.  If I don't do this, the secondary axis breaks will not align with the break lines shown in the primary axis - this makes the plot harder to read.  
```{r}
#td = total deaths 
#set base for first axis 
td_base <- 5000

#first/main y-axis limit 
td_y1lim  <- Ylim(current_US_deaths, td_base)

#max value for the secondary axis 
maxdeathperc <- max(covid19_US_adj$`Death Percentage`, na.rm=TRUE)

#set transform for sec axis 
#adjust the decimal to be the top value you want on the sec axis
# i.e. if you want the top value make it ylimit*(1/.10)
# the main axis is broken into 7 lines so I wanted a limit ....
#    ... that could also be broken into 7 lines; hence .07

#want both axes to have the same divsors 
#this way the secondary axis will match up with the primary axis
divisor <- td_y1lim/td_base
#round to the nearest percentage 
dp_base <- divisor/100
Rmaxdeathperc <- func_mround(maxdeathperc, dp_base)

#if the round is < actual then limit is round + sec_base
if( Rmaxdeathperc - maxdeathperc < 0 ){
  td_y2lim <- Rmaxdeathperc + dp_base
} else {
  td_y2lim <- Rmaxdeathperc
}
td_transform <- td_y1lim*(1/td_y2lim)
```

```{r}
#Start by plotting the primary data: total deaths.    

plot_td <- ggplot(covid19_US_adj, aes(x=Date))+
  #use geom_col because counts per day have alread been counted 
  geom_col(aes(y=`Total Deaths`), alpha=0.6)+
  #add total dealths label 
  geom_label(
      data = current_values
    #format label so there is a comma after three places 
    , aes(
        label = formatC(`Total Deaths`, big.mark=",", format="d")
      , y     = `Total Deaths`
      )
    )
```

```{r}
#Then, plot the secondary data: death percentage.  

plot_td <- plot_td + 
  geom_line(
    data = covid19_US_adj, 
    #transformatio to match secondary axis below
      aes(y=`Death Percentage`*td_transform)
    , color=AccentCol01
    , size= 1
    )+
  geom_point(
    data = covid19_US_adj, 
    #transformatio to match secondary axis below
      aes(y=`Death Percentage`*td_transform)
    #color 
    , color=AccentCol01
    , size= 2
    )+
  #add label to most recent value 
  geom_label_repel(
      data = current_values
    , aes(
        label = percent(`Death Percentage`, accuracy=0.001)
      # remember to add the transform! 
      , y     = `Death Percentage`*td_transform 
      )
    , seed = 100
    , box.padding = 0.6 
    , hjust = 0
    , vjust = 1
    , color = AccentCol01
    )
```

```{r }
#It is imparative to add the scales.  

plot_td <- plot_td + 
  #scale the date to be onece a week 
  #add specific limits so it will line up with geom_line 
  scale_x_date(breaks=date_breaks("7 days")
              , labels = date_format("%b-%d")
              , minor_breaks=date_breaks("1 day")
              , lim = c(as.Date(startdate)+.5, as.Date(current_date)+1)  
              )+
  #add commas to numbers in y axis; requires scales package
  scale_y_continuous(
      limits = c(0, td_y1lim)
    #add commas to numbers in y axis; requires scales package
    , labels = comma
    #this transformation MUST match the transformation above
    #divide by current_US_deaths leads to an axis of 0 to 1
    #divide by current_US_deaths*10 leads to an axis of 0 to 0.1
    , sec.axis = sec_axis(~./td_transform)    )
```

```{r }
#Finally, a title and other themes are specified.    

plot_td <- plot_td + 
  #add title 
  ggtitle("Total Deaths and Dealth Percentage of COVID-19 in the United States by Day")+
  #minimal theme
  theme_minimal()+
  theme(
    #remove all legents 
     legend.position = "none"
     # remove x and y axes 
    , axis.title.x = element_blank()
    , axis.title.y = element_blank()
  )

plot_td
```

### Values for Past Week 


Although the growth rate appears to be starting to slow down; the death percentage has been consistently going up over the past 4 weeks and is almost at 5%.  

```{r}
#transpose table; easier to read
covid19_US_adj %>%
  arrange(desc(Date)) %>%
  top_n(7, wt=Date) %>%
  #format data for output tabel 
  mutate(
      #Date = format(Date, format="%a,   %b   %d,   %Y")
      Date = format(Date, '%a, %b %d, %Y')
    , `Total Deaths` = formatC(`Total Deaths`, big.mark=",", format="d")
    , `Total Cases` = formatC(`Total Cases`, big.mark=",", format="d")
    , `Daily Cases`  = formatC(`Daily Cases`, big.mark=",", format="d")
    , `Growth Factor` = round(`Growth Factor`, 4)
    , `Death Percentage` = percent(`Death Percentage`, accuracy=0.001)
  ) %>%
  kable(align=c('l', rep('r', 5))) %>%
  kable_styling(
    bootstrap_options = c(
      #adds stiped color to rows
        "striped"
      #highlight row when hover over it 
      , "hover"
      #table doesn't have to be full width 
      , full_width = FALSE
      )
    ) %>%
  row_spec(1, bold=T, color="white", background = "rgba(0, 0, 0, .5)")

```
