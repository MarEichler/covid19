---
title: ""
output:
  html_document:
    highlight: "tango"
editor_options: 
  chunk_output_type: console
---

```{r packages-global-options, results="hide", warning=FALSE, message=FALSE, include = FALSE, eval = TRUE }
#not needed for knitting with other rmd 
library(tidyverse)
library(gridExtra)
library(grid)
library(knitr)
library(lubridate)
library(scales)
library(ggrepel)
library(kableExtra)
library(latex2exp)
library(cowplot)
knitr::opts_chunk$set(fig.width=8, fig.height = 4, dpi=300, echo=FALSE)
source("script/variable/colors.R") #colors 
source("script/dataframe/covid19_US.R") #run script for covid19 df 
source("script/variable/parameters.R") #global parameters; also imports data 
```


### Is the pandemic slowing? 

One important calculation is the growth factor, as outlined in <a href = "https://www.youtube.com/watch?v=Kas0tIxDvrg" target = "_blank"> 3Blue1Brown's youtube video on exponential growth </a>.  The growth factor is calculated as follows: 

$$
\text{Growth Factor} = \frac{ \text{New-Cases}_N}{\text{New-Cases}_{N-1}}
$$
where $N$ is a given day.  Essentialy this is taking the amount of new cases today and dividing them by the amount of new cases yesterday.  

The growth factor can be very helpful in determining if the pandemic is slowing.  If the growth factor is less than 1, this means that the amount of new cases today is less than yesterday.  Once there are multiple days with a growth factor less than 1 it is a strong sign that the pandemic is slowing down.  

#### Adjustment to Growth Factor
What if there were 0 cases yesterday?  This would make the growth factor undefined (or $\infty$ according to R).  This makes it difficult to look at trends.  I have adjusted the growth factor so that if the previous day had 0 cases, the current day's growth factor is equal to the number of new cases: 

$$
\text{Growth Factor} = \begin{cases}
\frac{ \text{New-Cases}_N}{\text{New-Cases}_{N-1}} & \text{if } \text{New-Cases}_{N-1} \neq 0 
\\[1ex]
\text{New-Cases}_N & \text{if } \text{New-Cases}_{N-1} = 0 
\end{cases}
$$
I made this adjustment for the early or late stages of the pandemic when the number of cases per day are 0, 1, or 2.  However, given the test scarcity and reporting times there are situations in counties or states where there are 0 cases one day and then hundreds or thousands the next day.  This large variability causes spikes in the growth factor in some plots. 


### Growth Factor Plot 

Similar to the new cases per day, there can be a lot of variability in growth factors  In order to get a better sense of the trend I am showing a 14-day moving average of the growth factor.  

The growth factor shows a different trend than new cases.  Here, the growth factor has stayed around 1 since mid-April.  Compare that to the new cases plot on the Overview tab, which shows a downward trend after a peak in mid-April.  The growth factor remaining around 1 may be due to the cyclical nature of new cases being reported (high during the week, low during the weekends) - but it could also be showing that although the decrease in new cases is a positive sign, we are not out of the woods yet.  

```{r}
#label for 14-day moving average 
labels_gf <- covid19_US %>% filter(date == as.Date("2020-05-02"))

ggplot(covid19_US_adj, aes(x=date, y=growth_factor))+
  red_box +
  geom_area(alpha = 0.3) +
  gf_info_cap +
  date_scaling +
  scale_y_continuous(limit = c(0, 2), expand = c(0, 0)) +
  theme_minimal()+
  theme(
      plot.title = element_text(hjust = 0.5, size = subtitle_size)
    , axis.title.x=element_blank()
    , axis.title.y=element_blank()
    , plot.margin  = margin(t=0, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  ) + 
  geom_line(
      aes(y = MA_growth_factor)
    , size = 1.25
    , color = blue_comp
    , alpha = 0.6
  ) + 
  geom_text_repel(
      seed = 100
    , data = labels_gf
    , aes(y = MA_growth_factor, label = "14-Day\nMoving Average")
    , color = blue_comp
    , nudge_y = 0.5
    , nudge_x = 3
  ) +
  ggtitle("Growth Factor per Day")

```


<br>  
  
### Recent Values by Day for US  

The actual values for the previous 14 days are detailed in the table below.  

```{r values-table-gf}
#transpose table; easier to read
covid19_US_adj %>%
  arrange(desc(date)) %>%
  top_n(14, wt=date) %>%
  #format data for output tabe
  mutate(
      Date = format(date, '%a, %b %d, %Y')
    , `Total Cases` = formatC(total_cases, big.mark=",", format="d")
    , `New Cases`  = formatC(new_cases, big.mark=",", format="d")
    , `Growth Factor` = round(growth_factor, 2)
    , `Growth Factor 14-day MA` = round(MA_growth_factor, 2)
    , `New Cases 14-Day MA` = formatC(MA_new_cases, big.mark=",", format="d")
  ) %>%
  #color Growth Factor based on value 
  mutate(
    `Growth Factor` = cell_spec(
      `Growth Factor`, color = 
          ifelse( growth_factor > 1, gf2plus,
                  ifelse(growth_factor > 0, colorspace::lighten(gf2plus, 0.4), "grey35"))
      , bold = T
      ), 
    `Growth Factor 14-day MA` = cell_spec(
      `Growth Factor 14-day MA`, color = 
          ifelse( MA_growth_factor > 1, gf2plus,
                  ifelse(growth_factor > 0, colorspace::lighten(gf2plus, 0.4), "grey35"))
      , bold = T
      )
  ) %>%
  #re-order to group cases and death information together 
  select(
      Date
    , `Total Cases`
    , `New Cases`
    , `New Cases 14-Day MA`
    , `Growth Factor`
    , `Growth Factor 14-day MA`
    ) %>%
  kable(
    align=c('l', rep('r', 6))
    , escape = F
  ) %>%
  kable_styling(
    bootstrap_options = c(
      #adds stiped color to rows
        "striped"
      #highlight row when hover over it 
      , "hover"
      #table doesn't have to be full width 
      , full_width = FALSE
      #make it horizontally scrollable
      , "responsive"
      )
    )  %>%
  row_spec(1, bold=T, background = "rgba(0, 0, 0, .05)")
```

