---
title: ""
output:
  html_document:
    highlight: "tango"
editor_options: 
  chunk_output_type: console
---

```{r packages-global-options, results="hide", warning=FALSE, message=FALSE, include = FALSE, eval = TRUE }
#not needed for knitting with other rmd 
library(tidyverse)
library(gridExtra)
library(grid)
library(knitr)
library(lubridate)
library(scales)
library(ggrepel)
library(kableExtra)
library(latex2exp)
library(cowplot)
knitr::opts_chunk$set(fig.width=8, fig.height = 4, dpi=300, echo=FALSE)
source("script/variable/colors.R") #colors 
source("script/dataframe/covid19_US.R") #run script for covid19 df 
source("script/variable/parameters.R") #global parameters; also imports data 
```


### Is the pandemic slowing? 

One important calculation is the growth factor, as outlined in <a href = "https://www.youtube.com/watch?v=Kas0tIxDvrg" target = "_blank"> 3Blue1Brown's youtube video on exponential growth </a>.  The growth factor is calculated as follows: 

$$
\text{Growth Factor} = \frac{ \text{New-Cases}_N}{\text{New-Cases}_{N-1}}
$$
where $N$ is a given day.  Essentialy this is taking the amount of new cases today and dividing them by the amount of new cases yesterday.  

The growth factor can be very helpful in determining if the pandemic is slowing.  If the growth factor is less than 1, this means that the amount of new cases today is less than yesterday.  Once there are multiple days with a growth factor less than 1 it is a strong sign that the pandemic is slowing down.  

#### Adjustment to Growth Factor
What if there were 0 cases yesterday?  This would make the growth factor undefined (or $\infty$ according to R).  This makes it difficult to look at trends.  I have adjusted the growth factor so that if the previous day had 0 cases, the current day's growth factor is equal to the number of new cases: 

$$
\text{Growth Factor} = \begin{cases}
\frac{ \text{New-Cases}_N}{\text{New-Cases}_{N-1}} & \text{if } \text{New-Cases}_{N-1} \neq 0 
\\[1ex]
\text{New-Cases}_N & \text{if } \text{New-Cases}_{N-1} = 0 
\end{cases}
$$
I made this adjustment for the early or late stages of the pandemic when the number of cases per day are 0, 1, or 2.  However, given the test scarcity and reporting times there are situations in counties or states where there are 0 cases one day and then hundreds or thousands the next day.  This large variability causes spikes in the growth factor in some plots. 


### Growth Factor Plot 

Similar to the new cases per day, there can be a lot of variability in growth factors  In order to get a better sense of the trend I am showing a 7-day moving average of the growth factor.  

Between mid-April and mid-June the growth factor hovered around 1, showing that although cases were decreasing there was not substantial decrease in growth.  After states began to re-open there was a dramatic increase in new-cases starting in mid-June.  Between mid-June and mid-July cases started increasing dramatically which lead lead to the 7-day moving average growth rate to be above 1 for a month.  Since mid-July the growth factor has oscillating around 1.  

```{r, eval = FALSE }
#label for 14-day moving average 
labels_gf <- covid19_US %>% filter(date == as.Date("2020-05-02"))

ggplot(covid19_US_adj, aes(x=date, y=growth_factor))+
  red_box +
  geom_area(alpha = 0.3) +
  gf_info_cap +
  date_scaling +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian(ylim = c(min(0.5, min(covid19_US_adj$growth_factor)), 1.5)) + #zoom into a certain part of graph
  theme_minimal()+
  theme(
      plot.title = element_text(hjust = 0.5, size = subtitle_size)
    , axis.title.x=element_blank()
    , axis.title.y=element_blank()
    , plot.margin  = margin(t=0, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  ) + 
  geom_line(
      aes(y = MA_growth_factor)
    , size = 1.25
    , color = blue_comp
    , alpha = 0.6
  ) + 
  geom_text_repel(
      seed = 100
    , data = labels_gf
    , aes(y = MA_growth_factor, label = "7-Day\nMoving Average")
    , color = blue_comp
    , nudge_y = 0.5
    , nudge_x = 3
  ) +
  ggtitle("Growth Factor per Day")

```

```{r}
ggplot(covid19_US_adj, aes(x=date, y= MA_growth_factor - 1))+
  annotate("rect", xmin = x_min, xmax = x_max, ymin = 0, ymax =  Inf, fill = gf2plus, alpha = 0.2) + 
  geom_area(alpha = 0.3, fill = blue_comp) +
  annotate("text", x = x_min + 1, y = -0.5, label = cap_gf, vjust=-0.3, hjust= -0.1, size = 3, color = "grey15") +
  date_scaling +
  scale_y_continuous(expand = c(0, 0), limits = c(-0.5, 0.5), breaks = seq(-0.5, 0.5, .25), labels = seq(.5, 1.5, .25)) +
  theme_minimal()+
  theme(
    plot.title = element_text(hjust = 0.5, size = subtitle_size)
    , axis.title.x=element_blank()
    , axis.title.y=element_blank()
    , plot.margin  = margin(t=0, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  ) + 
  ggtitle("7-Day Moving Average of Growth Factor")
```



<br>  
  
### Recent Values by Day for US  

The actual values for the previous 14 days are detailed in the table below.  

```{r values-table-gf}
#transpose table; easier to read
covid19_US_adj %>%
  arrange(desc(date)) %>%
  top_n(14, wt=date) %>%
  #format data for output tabe
  mutate(
      Date = format(date, '%a, %b %d, %Y')
    , `Total Cases` = formatC(total_cases, big.mark=",", format="d")
    , `New Cases`  = formatC(new_cases, big.mark=",", format="d")
    , `Growth Factor` = round(growth_factor, 2)
    , `Growth Factor 7-day MA` = round(MA_growth_factor, 2)
    , `New Cases 7-Day MA` = formatC(MA_new_cases, big.mark=",", format="d")
  ) %>%
  #color Growth Factor based on value 
  mutate(
    `Growth Factor` = cell_spec(
      `Growth Factor`, color = 
          ifelse( growth_factor > 1, gf2plus,
                  ifelse(growth_factor > 0, colorspace::lighten(gf2plus, 0.4), "grey35"))
      , bold = T
      ), 
    `Growth Factor 7-day MA` = cell_spec(
      `Growth Factor 7-day MA`, color = 
          ifelse( MA_growth_factor > 1, gf2plus,
                  ifelse(growth_factor > 0, colorspace::lighten(gf2plus, 0.4), "grey35"))
      , bold = T
      )
  ) %>%
  #re-order to group cases and death information together 
  select(
      Date
    , `Total Cases`
    , `New Cases`
    , `New Cases 7-Day MA`
    , `Growth Factor`
    , `Growth Factor 7-day MA`
    ) %>%
  kable(
    align=c('l', rep('r', 6))
    , escape = F
  ) %>%
  kable_styling(
    bootstrap_options = c(
      #adds stiped color to rows
        "striped"
      #highlight row when hover over it 
      , "hover"
      #table doesn't have to be full width 
      , full_width = FALSE
      #make it horizontally scrollable
      , "responsive"
      )
    )  %>%
  row_spec(1, bold=T, background = "rgba(0, 0, 0, .05)")
```

