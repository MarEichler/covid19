---
title: ""
output:
  html_document:
    highlight: "tango"
editor_options: 
  chunk_output_type: console
---


```{r overview-outside-script, results="hide", warning=FALSE, message=FALSE, include = FALSE}
# source("script/variable/setup.R")
# source("script/dataframe/covid19.R") #run script for covid19 df
# source("script/variable/parameters.R") #global parameters
```


```{r overview-covid19_US}
#find current values to use as labels 
covid19_US <- covid19 %>% filter(geo == "USA")
```

 

###  Total Cases and Total Deaths  
These show the cumulative total of cases and deaths by day.  I have also denoted the current cumulative totals.  These total values are important; however they are not helpful for figuring out whether the pandemic is slowing down or growing as it is difficult to see trends in cumulative curves like these.

```{r overview-tc-td-plot, fig.height=3}

total_labels <- covid19_US %>%
  filter(date == max(date)) %>%
  mutate(
      case_total  = paste("Current Total", formatC(case_total,  big.mark=",", format="d"), sep = "\n")
    , death_total = paste("Current Total", formatC(death_total, big.mark=",", format="d"), sep = "\n")
  )

tc <- ggplot(covid19_US, aes(date, case_total)) + 
  geom_area(alpha = 0.4)+
  geom_line(
      size = 1
    , alpha = 0.6
  )+
  date_scaling +
  millions_scaling + 
  geom_text(
      data = total_labels 
    , aes(
          label = case_total
        , y = -Inf
        , x = max(date)
      )
    , vjust = -0.15
    , hjust=1.05 
    , size = 6
    , fontface = "bold"
    , color = "white"
    ) +
  theme_minimal() +
  ggtitle("Total Cases by Day (in millions)") +
  theme(
      plot.title = element_text(size = title_size, hjust = 0.5)
    , plot.margin  = margin(t=0, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  )

td <- ggplot(covid19_US, aes(date, death_total)) + 
  geom_area(alpha = 0.4)+
  geom_line(
      size = 1
    , alpha = 0.6
  )+
  date_scaling +
  thousands_scaling + 
  geom_text(
      data = total_labels 
    , aes(
          label = death_total
        , y = -Inf
        , x = max(date)
      )
    , vjust = -0.15
    , hjust=1.05 
    , size = 6
    , fontface = "bold"
    , color = "white"
    ) +
  theme_minimal() +
  ggtitle("Total Deaths by Day (in thousands)") +
  theme(
      plot.title = element_text(size = title_size, hjust = 0.5)
    , plot.margin  = margin(t=0, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  )

plot_grid(tc, td, nrow = 1)
```

<br>

### New Cases 

Looking at new cases each day can help us see if the pandemic is slowing.  A decreasing number of new cases per day is evidence that the pandemic is slowing down.  

There can be a lot of variability in the daily case totals due to a variety of variables.  One example is the availability of tests; cases will go down if there is a scarcity of tests and rise dramatically when more tests become available.  There is also a cyclical nature to the daily new cases with counts often being lower on weekends and higher on weekdays. One way to help get a better sense of the overall trend is by smoothing the data using a moving average.  



```{r overview-dc-plot, warning = FALSE}  

# set labels, top of second wave 
labels_dc <- covid19_US %>% 
  filter(date >= as.Date("2020-07-01"), date <= as.Date("2020-10-01")) %>% 
  mutate(max = ifelse(case_new == max(case_new), 1, 0)) %>%
  filter(max == 1)

#daily cases plot
ggplot(covid19_US, aes(x=date, y=case_new))+
  geom_col(alpha=0.3) +
  geom_line(
    aes(y = case_MA7)
    , size = 1.25
    , color = blue_comp
    , alpha = 0.6
  ) +
  geom_text_repel(
      seed = 100
    , data = labels_dc
    , aes(y = case_MA7, label = "7-Day\nMoving Average")
    , color = blue_comp
    , nudge_y = 25000
    , nudge_x = -20
  ) +
  ggtitle("New Cases per Day") +
  date_scaling +
  thousands_scaling +
  theme_minimal()+
  theme(
      plot.title = element_text(hjust = 0.5, size = subtitle_size)
    , axis.title.x=element_blank()
    , axis.title.y=element_blank()
    , plot.margin  = margin(t=0, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  ) 
```

<br>

### New Deaths and Case Fatality   

COVID-19 is much deadlier than the common flu.  One way to measure the impact is to look at the case fatality percentage, which is the total number of deaths divided by the total number of cases.  


Similar to new cases there is a cyclical nature to daily deaths.  This may be due to reporting times where counts on weekdays are often higher than those on weekends.  Other variability in the data can also occurs when states change how they are assigning COVID-19 deaths, such as counting nursing home deaths and/or pneumonia deaths as COVID-19 deaths.  


```{r overview-new-death-and-death-prop}

death_prop_max <- covid19_US %>% filter(date >= x_min) %>% pull(death_prop) %>% max

plot_dp <- ggplot(covid19_US, aes(date, death_prop)) + 
  geom_line(color = "grey40", size = 1) + 
  date_scaling + 
  scale_y_continuous(
      name = "Total Dealths / Total Cases"
    , limits = c(0, death_prop_max)
    , labels = scales::percent
  ) +
  ggtitle("Case Fatality Percentage per Day") + 
  theme_minimal()+
  theme(
      plot.title = element_text(hjust = 0.5, size = subtitle_size)
    , axis.title.x=element_blank()
    , plot.margin  = margin(t=0, r=15, b=15, l=0)
    , axis.ticks.length = unit(5, "pt")
  )

labels_nd <- covid19_US %>% 
  filter(date >= as.Date("2020-07-01"), date <= as.Date("2020-10-01")) %>% 
  mutate(max = ifelse(death_new == max(death_new), 1, 0)) %>%
  filter(max == 1)

plot_nd <-ggplot(covid19_US, aes(date, death_new)) + 
  geom_col(alpha=0.3) +
  geom_line(
    aes(y = death_MA7)
    , size = 1.25
    , color = blue_comp
    , alpha = 0.6
  )  +
  date_scaling + 
  thousands_scaling +
  geom_text_repel(
      seed = 100
    , data = labels_nd
    , aes(y = death_MA7, label = "7-Day\nMoving Average")
    , color = blue_comp
    , nudge_y = 5000
    , nudge_x = -10
  ) +
  ggtitle("New Deaths per Day") + 
  theme_minimal()+
  theme(
      plot.title = element_text(hjust = 0.5, size = subtitle_size)
    , axis.title.x=element_blank()
    , axis.title.y=element_blank()
    , plot.margin  = margin(t=15, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  )


cowplot::plot_grid(
    plot_dp
  , plot_nd
  , nrow = 1
  , align = "h"
)
```

<br>

### Values for Past 14 Days  

The actual values for the previous 14 days are detailed in the table below.  

```{r overview-values-table}
#transpose table; easier to read
covid19_US %>%
  arrange(desc(date)) %>%
  top_n(14, wt=date) %>%
  #format data for output table 
  mutate(
       Date = format(date, '%a, %b %d, %Y')
    , `Total Cases`     = formatC(case_total, big.mark=",", format="d")
    , `New Cases`       = formatC(case_new,    big.mark=",", format="d")
    , `New Cases 7-MA`  = formatC(case_MA7,    big.mark=",", format="d")
    , `Total Deaths`    = formatC(death_total, big.mark=",", format="d")
    , `New Deaths`      = formatC(death_new,   big.mark=",", format="d")
    , `New Deaths 7-MA` = formatC(death_MA7, big.mark=",", format="d")
    , `Death Percentage` = percent(death_prop, accuracy=0.001)
  ) %>%
  #re-order to group cases and death information together 
  select(
      Date
    , `Total Cases`
    , `Total Deaths`
    , `New Cases`
    , `New Cases 7-MA`
    , `New Deaths`
    , `New Deaths 7-MA`
    , `Death Percentage`
    ) %>%
  kable(
    align=c('l', rep('r', 7))
    , escape = F
  ) %>%
  kable_styling(
    bootstrap_options = c(
      #adds stiped color to rows
        "striped"
      #highlight row when hover over it 
      , "hover"
      #table doesn't have to be full width 
      , full_width = FALSE
      #make it horizontally scrollable
      , "responsive"
      )
    ) %>%
  row_spec(1, bold=T, background = "rgba(0, 0, 0, .05)")
```
