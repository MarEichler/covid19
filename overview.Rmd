---
title: ""
output:
  html_document:
    highlight: "tango"
editor_options: 
  chunk_output_type: console
---


```{r, results="hide", warning=FALSE, message=FALSE, include = FALSE}
library(tidyverse)
library(gridExtra)
library(grid)
library(knitr)
library(lubridate)
library(scales)
library(ggrepel)
library(kableExtra)
library(zoo)
library(latex2exp)
library(cowplot)
knitr::opts_chunk$set(fig.width=8, fig.height = 4, dpi=300, echo=FALSE)
```

```{r outside-scripts}
source("script/variable/colors.R") #colors 
source("script/dataframe/covid19_US.R") #run script for covid19 df 
source("script/variable/parameters.R") #global parameters 
```


```{r current-values}
#find current values to use as labels 

current_values <- covid19_US_adj %>%
    #return row that has current date
    filter(date == current_date)


current_US_deaths      <- current_values$total_deaths
current_US_totalcases  <- current_values$total_cases
current_US_newcases <- current_values$new_cases
current_US_growthfact  <- current_values$growth_factor
current_US_deathperc   <- current_values$death_percentage
current_US_newdeaths <- current_values$new_deaths
```

 

###  Total Cases and Total Deaths  
These show the cumulative total of cases and deaths by day.  I have also denoted the current cumulative totals.  These total values are important; however they are not helpful for figuring out whether the pandemic is slowing down or growing as it is difficult to see trends in cumulative curves like these.

```{r tc-td-plot, fig.height=3}
covid_tidy <- covid19_US_adj %>%
  select(date, total_cases, total_deaths) %>%
  pivot_longer(
      cols = c(total_cases, total_deaths)
    , names_to = "type"
    , values_to = "count"
  ) 

total_labels <- covid19_US_adj %>%
  filter(date == current_date) %>%
  mutate(
      total_cases = paste("Current Total", formatC(total_cases, big.mark=",", format="d"), sep = "\n")
    , total_deaths = paste("Current Total", formatC(total_deaths, big.mark=",", format="d"), sep = "\n")
  )


tc <- ggplot(covid19_US_adj, aes(date, total_cases)) + 
  geom_area(alpha = 0.4)+
  geom_line(
      size = 1
    , alpha = 0.6
  )+
  date_scaling +
  millions_scaling + 
  geom_text(
      data = total_labels 
    , aes(
          label = total_cases
        , y = -Inf
        , x = current_date
      )
    , vjust = -0.15
    , hjust=1.05 
    , size = 6
    , fontface = "bold"
    , color = "white"
    ) +
  theme_minimal() +
  ggtitle("Total Cases by Day (in millions)") +
  theme(
      plot.title = element_text(size = title_size, hjust = 0.5)
    , plot.margin  = margin(t=0, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  )

td <- ggplot(covid19_US_adj, aes(date, total_deaths)) + 
  geom_area(alpha = 0.4)+
  geom_line(
      size = 1
    , alpha = 0.6
  )+
  date_scaling +
  thousands_scaling + 
  geom_text(
      data = total_labels 
    , aes(
          label = total_deaths
        , y = -Inf
        , x = current_date
      )
    , vjust = -0.15
    , hjust=1.05 
    , size = 6
    , fontface = "bold"
    , color = "white"
    ) +
  theme_minimal() +
  ggtitle("Total Deaths by Day (in thousands)") +
  theme(
      plot.title = element_text(size = title_size, hjust = 0.5)
    , plot.margin  = margin(t=0, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  )

plot_grid(tc, td, nrow = 1)
```

<br>

### New Cases 

Looking at new cases each day can help us see if the pandemic is slowing.  A decreasing number of new cases per day is evidence that the pandemic is slowing down.  

There can be a lot of variability in the daily case totals due to a variety of variables.  One example is the availability of tests; cases will go down if there is a scarcity of tests and rise dramatically when more tests become available.  One way to help get a better sense of the overall trend is by smoothing the data using a moving average.  

The trends and raw data show a peak around mid-April and had been moving downward likely due to strict lock-down and social distancing measures.  In late June, new cases started to increase dramatically, forming a second peak as many states start re-opening and many people stop practicing social distancing measures.  A new peak formed around mid-July and cases started decreasing at the end of July.  In the fall, cases starting rising again and a new peek formed at the beginning of November with some days having more than 100k new cases.  

There is also a cyclical nature to the daily new cases with counts often being lower on weekends and higher on weekdays. 




```{r dc-plot, warning = FALSE}  
#label sets
labels_dc <- covid19_US %>% filter(date == as.Date("2020-06-20"))


#daily cases plot
ggplot(covid19_US_adj, aes(x=date, y=new_cases))+
  geom_col(alpha=0.3) +
  geom_line(
    aes(y = MA_new_cases)
    , size = 1.25
    , color = blue_comp
    , alpha = 0.6
  ) +
  geom_text_repel(
      seed = 100
    , data = labels_dc
    , aes(y = MA_new_cases, label = "7-Day\nMoving Average")
    , color = blue_comp
    , nudge_y = 10000
    , nudge_x = -20
  ) +
  ggtitle("New Cases per Day") +
  date_scaling +
  thousands_scaling +
  theme_minimal()+
  theme(
      plot.title = element_text(hjust = 0.5, size = subtitle_size)
    , axis.title.x=element_blank()
    , axis.title.y=element_blank()
    , plot.margin  = margin(t=0, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  ) 
```

<br>

### New Deaths and Death Percentage   

COVID-19 is much deadlier than the common flu.  One way to measure the impact is to look at the death percentage, which is the total number of deaths divided by the total number of cases.  

A big concern during April was that the death percentage was continually increasing, even when actual deaths per day were not increasing.  Starting in early May the death percentage started to plateau around 6%.  At the end of May, the death percentage starts curving downward as deaths per day continued to decrease as new cases per days continued to plateau and then increase.  In July, daily deaths started to increase.   

Similar to new cases there is a cyclical nature to spikes in new cases.  These spikes may be due to reporting times where counts on weekdays are often higher than those on weekends.  Spikes also occur when previous deaths are re-assigned as COVID-19 related deaths, such as counting nursing home deaths and/or pneumonia deaths.  In late June, states began to add probable deaths to the death count: Delaware (June 23rd), New Jersey (June 25th), and New York (June 30th).  On July 27th, Texas announced a change in the way it counts deaths.  

```{r dp-plot}
plot_dp <- ggplot(covid19_US_adj, aes(date, death_percentage)) + 
  geom_line(color = "grey40", size = 1) + 
  date_scaling + 
  scale_y_continuous(
      name = "Total Dealths / Total Cases"
    , limits = c(0, NA)
    , labels = scales::percent
  ) +
  ggtitle("Dealth Percentage per Day") + 
  theme_minimal()+
  theme(
      plot.title = element_text(hjust = 0.5, size = subtitle_size)
    , axis.title.x=element_blank()
    , plot.margin  = margin(t=0, r=15, b=15, l=0)
    , axis.ticks.length = unit(5, "pt")
  )
```

```{r nd-plot}
labels_nd <- covid19_US %>% filter(date == as.Date("2020-05-01"))

plot_nd <-ggplot(covid19_US_adj, aes(date, new_deaths)) + 
  geom_col(alpha=0.3) +
  geom_line(
    aes(y = MA_new_deaths)
    , size = 1.25
    , color = blue_comp
    , alpha = 0.6
  )  +
  date_scaling + 
  thousands_scaling +
  geom_text_repel(
      seed = 100
    , data = labels_nd
    , aes(y = MA_new_deaths, label = "7-Day\nMoving Average")
    , color = blue_comp
    , nudge_y = 2000
    , nudge_x = 2
  ) +
  ggtitle("New Deaths per Day") + 
  theme_minimal()+
  theme(
      plot.title = element_text(hjust = 0.5, size = subtitle_size)
    , axis.title.x=element_blank()
    , axis.title.y=element_blank()
    , plot.margin  = margin(t=15, r=15, b=0, l=0)
    , axis.ticks.length = unit(5, "pt")
  )

```


```{r dp-nd-plot}
cowplot::plot_grid(
    plot_dp
  , plot_nd
  , nrow = 1
  , align = "h"
)
```

<br>

### Values for Past 14 Days  

The actual values for the previous 14 days are detailed in the table below.  

```{r values-table}
#transpose table; easier to read
covid19_US_adj %>%
  arrange(desc(date)) %>%
  top_n(14, wt=date) %>%
  #format data for output table 
  mutate(
      Date = format(date, '%a, %b %d, %Y')
    , `Total Cases` = formatC(total_cases, big.mark=",", format="d")
    , `New Cases`  = formatC(new_cases, big.mark=",", format="d")
    , `New Cases 7-MA` = formatC(MA_new_cases, big.mark=",", format="d")
    , `Total Deaths` = formatC(total_deaths, big.mark=",", format="d")
    , `New Deaths` = formatC(new_deaths, big.mark=",", format="d")
    , `New Deaths 7-MA` = formatC(MA_new_deaths, big.mark=",", format="d")
    , `Death Percentage` = percent(death_percentage, accuracy=0.001)
  ) %>%
  #re-order to group cases and death information together 
  select(
      Date
    , `Total Cases`
    , `Total Deaths`
    , `New Cases`
    , `New Cases 7-MA`
    , `New Deaths`
    , `New Deaths 7-MA`
    , `Death Percentage`
    ) %>%
  kable(
    align=c('l', rep('r', 7))
    , escape = F
  ) %>%
  kable_styling(
    bootstrap_options = c(
      #adds stiped color to rows
        "striped"
      #highlight row when hover over it 
      , "hover"
      #table doesn't have to be full width 
      , full_width = FALSE
      #make it horizontally scrollable
      , "responsive"
      )
    ) %>%
  row_spec(1, bold=T, background = "rgba(0, 0, 0, .05)")
```
